#+TITLE: ob-tmux-extensions
#+AUTHOR: ii.coop

=ob-tmux= is =:results silent=. These extensions fix that.

[[https://github.com/ahendriksen/ob-tmux/issues/6][Issue #6]] has been open for six years: you =C-c C-c= a tmux block, the command runs, but nothing comes back to your org file. This repo adds output capture, asciinema recording, and live streaming to =ob-tmux= blocks.

* Posts

Each =.org= file is both an executable demo and a publishable post (via [[https://github.com/ii/ox-ghost][ox-ghost]]).

- [[file:ob-tmux-capture.org][ob-tmux-capture]] --- Getting results back. Marker-based capture, pane snapshots, output filtering, and an agent-pair demo showing two Claudes talking via tmux.
- [[file:ob-tmux-asciinema.org][ob-tmux-asciinema]] --- Streaming and recording. Live terminal sessions, cast files, =#+BEGIN_ASCIINEMA= embeds. /(coming soon)/
- [[file:ob-tmux-live.org][ob-tmux-live]] --- Live literate programming. Stream-to-post workflow. /(coming soon)/

* Packages

| Package | File | Purpose |
|---------+------+---------|
| =ob-tmux-capture= | [[file:ob-tmux-capture.el][ob-tmux-capture.el]] | Capture tmux pane output (markers, pane snapshot) |
| =ob-tmux-asciinema= | [[file:ob-tmux-asciinema.el][ob-tmux-asciinema.el]] | Asciinema recording, streaming, metadata |

The =.el= files are standalone packages. The =.org= files demonstrate and document them --- they don't tangle/generate the elisp.

* Installation

** Doom Emacs

Add to =~/.config/doom/packages.el=:

#+begin_src emacs-lisp
(package! ob-tmux)
(package! ob-tmux-capture
  :recipe (:host github :repo "ii/ob-tmux-extensions"
           :files ("ob-tmux-capture.el")))
(package! ob-tmux-asciinema
  :recipe (:host github :repo "ii/ob-tmux-extensions"
           :files ("ob-tmux-asciinema.el")))
#+end_src

Add to =~/.config/doom/config.el=:

#+begin_src emacs-lisp
(use-package! ob-tmux-capture
  :after ob-tmux
  :config
  (ob-tmux-capture-enable-advice))

(use-package! ob-tmux-asciinema
  :after ob-tmux-capture
  :config
  (setq ob-tmux-asciinema-server-url "https://asciinema.mcclimans.net"))
#+end_src

Then: =~/.config/emacs/bin/doom sync=

** straight.el / use-package

#+begin_src emacs-lisp
(use-package ob-tmux-capture
  :straight (:host github :repo "ii/ob-tmux-extensions"
             :files ("ob-tmux-capture.el"))
  :after ob-tmux
  :config
  (ob-tmux-capture-enable-advice))

(use-package ob-tmux-asciinema
  :straight (:host github :repo "ii/ob-tmux-extensions"
             :files ("ob-tmux-asciinema.el"))
  :after ob-tmux-capture)
#+end_src

** Manual

#+begin_src emacs-lisp
(add-to-list 'load-path "~/src/ob-tmux-extensions")
(require 'ob-tmux-capture)
(require 'ob-tmux-asciinema)
(ob-tmux-capture-enable-advice)
#+end_src

* Quick Start

** 1. Create a tmux session

#+begin_src shell
tmux has-session -t demo 2>/dev/null || tmux new-session -d -s demo -n main
#+end_src

** 2. Capture with markers (execute + capture)

#+begin_src org
,#+begin_src tmux :session demo:main :capture markers
kubectl get pods
,#+end_src
#+end_src

** 3. Pane snapshot (grab what's on screen)

#+begin_src org
,#+begin_src tmux :session demo:main :capture pane
,#+end_src
#+end_src

** 4. Record with asciinema

#+begin_src org
,#+begin_src tmux :session demo:main :capture asciinema :log yes
echo "Recording this!"
,#+end_src
#+end_src

* Header Arguments

| Argument | Values | Default | Description |
|----------+--------+---------+-------------|
| =:capture= | =pane=, =markers=, =asciinema= | =markers= | Capture method |
| =:timeout= | seconds | =30= | Max wait time |
| =:lines= | N or -N | /none/ | First/last N lines of output |
| =:grep= | regex | /none/ | Filter output lines |
| =:raw= | =yes= / =no= | =no= | Keep prompts and echoes |
| =:scrollback= | lines | /visible/ | Pane history depth |
| =:log= | =yes= / =no= | =no= | CAST_LOG drawer (asciinema) |
| =:stream-to= | stream-id | /none/ | Remote streaming (asciinema) |
| =:keep-cast= | =yes= / =no= | =no= | Retain local cast file |
| =:idle-limit= | seconds | =2= | Max idle in recording |

* Troubleshooting

** Capture not working after install

Check that advice is enabled:

#+begin_src emacs-lisp :results output
(princ (if (advice-member-p 'ob-tmux-capture-advice-execute 'org-babel-execute:tmux)
           "Advice enabled"
         "Advice NOT enabled - run (ob-tmux-capture-enable-advice)"))
#+end_src

** Package not found after doom sync

#+begin_src shell
~/.config/emacs/bin/doom doctor
#+end_src

Rebuild: =M-x straight-rebuild-package RET ob-tmux-capture=

* Credits

Built by [[https://ii.coop][ii.coop]], solving [[https://github.com/ahendriksen/ob-tmux/issues/6][ahendriksen/ob-tmux#6]].

Based on =ob-tmux= by Allard Hendriksen.
